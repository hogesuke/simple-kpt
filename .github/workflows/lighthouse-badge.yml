name: Lighthouse Badge

on:
  schedule:
    # 6æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  lighthouse:
    name: Lighthouse Badge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: lighthouserc.badge.cjs
          uploadArtifacts: true

      - name: Calculate average scores
        id: scores
        run: |
          MANIFEST='${{ steps.lighthouse.outputs.manifest }}'

          # å„ã‚«ãƒ†ã‚´ãƒªã®å¹³å‡ã‚’è¨ˆç®—
          PERF=$(echo "$MANIFEST" | jq '[.[].summary.performance] | add / length * 100 | floor')
          A11Y=$(echo "$MANIFEST" | jq '[.[].summary.accessibility] | add / length * 100 | floor')
          BP=$(echo "$MANIFEST" | jq '[.[].summary["best-practices"]] | add / length * 100 | floor')
          SEO=$(echo "$MANIFEST" | jq '[.[].summary.seo] | add / length * 100 | floor')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best-practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Create badge directory
        run: mkdir -p .github/badges

      - name: Generate badge JSON files
        run: |
          # ã‚¹ã‚³ã‚¢ã«ã‚ˆã‚Šè‰²ã‚’åˆ¤å®šã™ã‚‹
          get_color() {
            if [ $1 -ge 90 ]; then echo "brightgreen"
            elif [ $1 -ge 50 ]; then echo "orange"
            else echo "red"
            fi
          }

          PERF=${{ steps.scores.outputs.performance }}
          A11Y=${{ steps.scores.outputs.accessibility }}
          BP="${{ steps.scores.outputs.best-practices }}"
          SEO=${{ steps.scores.outputs.seo }}

          echo "{\"schemaVersion\":1,\"label\":\"Performance\",\"message\":\"$PERF\",\"color\":\"$(get_color $PERF)\"}" > .github/badges/lighthouse-performance.json
          echo "{\"schemaVersion\":1,\"label\":\"Accessibility\",\"message\":\"$A11Y\",\"color\":\"$(get_color $A11Y)\"}" > .github/badges/lighthouse-accessibility.json
          echo "{\"schemaVersion\":1,\"label\":\"Best Practices\",\"message\":\"$BP\",\"color\":\"$(get_color $BP)\"}" > .github/badges/lighthouse-best-practices.json
          echo "{\"schemaVersion\":1,\"label\":\"SEO\",\"message\":\"$SEO\",\"color\":\"$(get_color $SEO)\"}" > .github/badges/lighthouse-seo.json

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update lighthouse scores"
          title: "chore: update lighthouse scores"
          body: |
            Lighthouseã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚

            - Performance: ${{ steps.scores.outputs.performance }}
            - Accessibility: ${{ steps.scores.outputs.accessibility }}
            - Best Practices: ${{ steps.scores.outputs.best-practices }}
            - SEO: ${{ steps.scores.outputs.seo }}

            ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          branch: chore/update-lighthouse-scores
          delete-branch: true

      - name: Auto merge
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
